<!--
 From https://developers.google.com/gmail/contextual_gadgets#hello_world_example_code 
-->

<Module>
<ModulePrefs title="Create Redmine issue" description="Create issue from email body" height="20" author="Martin Růžička" author_email="martin.ruzicka@eman.cz" author_location="Prague, Czech Republic">
<Require feature="dynamic-height"/>
<Require feature="google.contentmatch">
<Param name="extractors">google.com:EmailBodyExtractor</Param>
</Require>
</ModulePrefs>
<Content type="html" view="card">
<![CDATA[
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
<script type="text/javascript">
	
	var REDMINE_API_KEY = "acfc408436a5d9a15a028b986e91a5cd8ed29963";
	var DOMAIN = "https://redmine2.dev.eman.cz";
		
		function createIssue() {
			var xhttp = new XMLHttpRequest();
	  		xhttp.onreadystatechange = function() {
	    			if (xhttp.readyState == 4 && xhttp.status == 201) {
	    				var object = JSON.parse(xhttp.responseText);
					var win = window.open( DOMAIN + '/issues/' + object.issue.id.toString(), '_blank');
					if(win) {
    						//Browser has allowed it to be opened
    						win.focus();
 					} else {
						//Broswer has blocked it
    						alert('Please allow popups for this site');
					}
		    		} else { }
			}
	  
	  	   	xhttp.open("POST", DOMAIN + "/issues.json", true);
		   	xhttp.setRequestHeader("Content-Type", "application/json");
	   	   	xhttp.setRequestHeader("X-Redmine-API-Key", REDMINE_API_KEY);
		   
		   	var e = document.getElementById("IDForSelect");
		   	var strProjectID = e.options[e.selectedIndex].value;
		   	
		   	matches = google.contentmatch.getContentMatches();        
        		var bodyText = matches[0]["email_body"];
        		
        		var issue = document.getElementById("MyTextField");
		   	var name = issue.value;
		   	
		   	var data = '{"issue":{"subject":"' + name + '","description":"' + bodyText + '"},"project_id":"' + strProjectID + '"}';
	  	   	xhttp.send(data);
	    	}; 
		
		var xhttp = new XMLHttpRequest();
	  	xhttp.onreadystatechange = function() {
	    		if (xhttp.readyState == 4 && xhttp.status == 200) {
				var object = JSON.parse(xhttp.responseText);					
				var select = document.createElement("select");
				select.setAttribute("id", "IDForSelect");

				for (var i = 0; i < object.projects.length; i++) {
			    		var x = document.createElement("option");
			    		x.setAttribute("value", object.projects[i].identifier);
			    		var t = document.createTextNode(object.projects[i].name);
			    		x.appendChild(t);
			    		select.appendChild(x);
				}
				document.body.appendChild(select);
	    		} else { }
	  	};
	  xhttp.open("GET", DOMAIN + "/projects.json", true);
	  xhttp.setRequestHeader("X-Redmine-API-Key", REDMINE_API_KEY);
	  xhttp.send();
	
	var btn = document.createElement("BUTTON");        // Create a <button> element
	btn.onclick = createIssue;
	var t = document.createTextNode("Vytvořit issue");       // Create a text node
	btn.appendChild(t);                                // Append the text to <button>
	document.body.appendChild(btn);                    // Append <button> to <body>
	
	var field = document.createElement("INPUT");
	field.setAttribute("type", "text");
	field.setAttribute("id", "MyTextField");
	field.setAttribute("value", "Nový úkol");
	document.body.appendChild(field);
	
	var x = window.parent.getElementsByClassName("a3s aXjCH");
</script>
]]>
</Content>
</Module>
