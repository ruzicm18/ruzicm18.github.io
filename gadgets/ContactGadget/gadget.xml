<!--
 From https://developers.google.com/gmail/contextual_gadgets#hello_world_example_code 
-->

<Module>
<ModulePrefs title="Contact detail" description="Shows detail information of email sender" height="200" author="Martin Růžička" author_email="martin.ruzicka@eman.cz" author_location="Prague, Czech Republic">
<Require feature="dynamic-height"/>
<Require feature="google.contentmatch">
<Param name="extractors">google.com:SenderEmailExtractor</Param>
</Require>
</ModulePrefs>
<Content type="html" view="card">
<![CDATA[
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
<script type="text/javascript">
	
	var REDMINE_API_KEY = "acfc408436a5d9a15a028b986e91a5cd8ed29963";
	var DOMAIN = "https://redmine2.dev.eman.cz";
	
   	var matches = google.contentmatch.getContentMatches();        
	var email = matches[0]["sender_email"];
	
	var xhttp = new XMLHttpRequest();
  	xhttp.onreadystatechange = function() {
    		if (xhttp.readyState == 4 && xhttp.status == 200) {
			var object = JSON.parse(xhttp.responseText);					
			
			if ( object.total_count == 0 ) {
				var h = document.createElement("H2");                // Create a <h1> element
				var t = document.createTextNode("Pro odesílatele se v Redmine nenachází žadný kontakt");     // Create a text node
				h.appendChild(t);
				document.body.appendChild(h);
			} else {
				var contact = object.contacts[0];
			
				var table_contact = document.createElement("TD");
				
				var contact_name  = document.createElement("H2");
				var t = document.createTextNode( contact.prefix + contact.first_name + contact.middle_name + contact.family_name + contact.suffix );
				contact_name.appendChild(t);
				
				table_contact.appendChild(contact_name);
				
				
				
				document.body.appendChild(table_contact);
			}
		}
  	};
  	xhttp.open("GET", DOMAIN + '/projects/crm/representatives.json?contact_email=' + email, true);
  	xhttp.setRequestHeader("X-Redmine-API-Key", REDMINE_API_KEY);
  	xhttp.send();
	
</script>
]]>
</Content>
</Module>