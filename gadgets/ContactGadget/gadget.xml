<!--
 From https://developers.google.com/gmail/contextual_gadgets#hello_world_example_code 
-->

<Module>
<ModulePrefs title="Contact detail" description="Shows detail information of email sender" height="200" author="Martin Růžička" author_email="martin.ruzicka@eman.cz" author_location="Prague, Czech Republic">
<Require feature="dynamic-height"/>
<Require feature="google.contentmatch">
<Param name="extractors">google.com:SenderEmailExtractor</Param>
</Require>
</ModulePrefs>
<Content type="html" view="card">
<![CDATA[
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
<script type="text/javascript">
	
	var REDMINE_API_KEY = "acfc408436a5d9a15a028b986e91a5cd8ed29963";
	var DOMAIN = "https://redmine2.dev.eman.cz";
	
   	var matches = google.contentmatch.getContentMatches();        
	var email = matches[0]["sender_email"];
	
	var xhttp = new XMLHttpRequest();
  	xhttp.onreadystatechange = function() {
    		if (xhttp.readyState == 4 && xhttp.status == 200) {
			var object = JSON.parse(xhttp.responseText);					
			
			if ( object.total_count == 0 ) {
				var h = document.createElement("H2");                // Create a <h1> element
				var t = document.createTextNode("Pro odesílatele se v Redmine nenachází žadný kontakt");     // Create a text node
				h.appendChild(t);
				document.body.appendChild(h);
			} else {
				var contact = object.contacts[0];
			
				var table_contact = document.createElement("TD");
				
				var contact_name  = document.createElement("H2");
				var text = document.createTextNode( getValue( contact.prefix ) + " " + getValue( contact.first_name ) + " " + getValue( contact.middle_name ) + " " + getValue( contact.family_name ) + " " +getValue( contact.suffix ) );
								contact_name.appendChild(text);
				table_contact.appendChild(contact_name);
				
				var c, r, t, left, right;
				    t = document.createElement('table');
					t.css({"font-size": 0.75em});
				    r = t.insertRow(0); 
				    left = r.insertCell(0);
				    right = r.insertCell(1);
					
					table_contact.appendChild(t);
					
					var leftTable = document.createElement('table');
					var rightTable = document.createElement('table');
					
					left.appendChild(leftTable);
					right.appendChild(rightTable);
					
					fillLeftTable (leftTable, contact);
					fillRightTable (rightTable, contact);
									
					//table_contact.innerText = table_contact.innerText.replace('undefined', '');
				
				document.body.appendChild(table_contact);
			}
		}
  	};
  	xhttp.open("GET", DOMAIN + '/projects/crm/representatives.json?contact_email=' + email, true);
  	xhttp.setRequestHeader("X-Redmine-API-Key", REDMINE_API_KEY);
  	xhttp.send();
	
	function getValue( object) {
		return (object == null ? "" : object )
	}
	
	function fillLeftTable (table, contact) {
		var i = 0;
		if ( contact.company != null ) {
		    var r = table.insertRow(i++); 
		    var left = r.insertCell(0);
		    var right = r.insertCell(1);
			
			left.innerHTML = "Company: ";
			right.innerHTML = contact.company;
		}
		if ( contact.job_title != null ) {
		    var r = table.insertRow(i++); 
		    var left = r.insertCell(0);
		    var right = r.insertCell(1);
			
			left.innerHTML = "Job title: ";
			right.innerHTML = contact.job_title;
		}
		if ( contact.birth_day != null ) {
		    var r = table.insertRow(i++); 
		    var left = r.insertCell(0);
		    var right = r.insertCell(1);
			
			left.innerHTML = "Birthday: ";
			right.innerHTML = contact.birth_day;
		}
		if ( contact.skype != null ) {
		    var r = table.insertRow(i++); 
		    var left = r.insertCell(0);
		    var right = r.insertCell(1);
			
			left.innerHTML = "Skype: ";
			right.innerHTML = contact.skype;
		}
		if ( contact.assignee != null ) {
		    var r = table.insertRow(i++); 
		    var left = r.insertCell(0);
		    var right = r.insertCell(1);
			
			left.innerHTML = "Assignee: ";
			right.innerHTML = contact.assignee;
		}
		if ( contact.tags != null && contact.tags.length > 0 ) {
		    var r = table.insertRow(i++); 
		    var left = r.insertCell(0);
		    var right = r.insertCell(1);
			left.innerHTML = "Tags: ";
			var text = "";
			for (var j = 0; j < contact.tags.length; j++ ) {
				if (j == 0) {
					text = contact.tags[j];
				} else {
			    	text = text + ", " + contact.tags[j];
				}
			}
			right.innerHTML = text;
		}
		
		
	};
	
	function fillRightTable (table, contact) {
		var i = 0;
		if ( contact.phones != null && contact.phones.length > 0 ) {
			for (var j = 0; j < contact.phones.length; j++ ) {
			    var r = table.insertRow(i++ ); 
			    var left = r.insertCell(0);
			    var right = r.insertCell(1);
				left.innerHTML = contact.phones[j].category;
				right.innerHTML = contact.phones[j].phone;
			}
		}
		if ( contact.emails != null && contact.emails.length > 0 ) {
			for (var j = 0; j < contact.emails.length; j++ ) {
			    var r = table.insertRow(i++ ); 
			    var left = r.insertCell(0);
			    var right = r.insertCell(1);
				left.innerHTML = contact.emails[j].category;
				right.innerHTML = contact.emails[j].email;
			}
		}
	};
	
	
	function onPageLoaded() {
	               gadgets.window.adjustHeight();
	                }
	
</script>
]]>
</Content>
</Module>