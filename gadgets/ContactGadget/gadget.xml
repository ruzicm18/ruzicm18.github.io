<!--
 From https://developers.google.com/gmail/contextual_gadgets#hello_world_example_code 
-->

<Module>
<ModulePrefs title="Contact detail" description="Shows detail information of email sender" height="220" author="Martin Růžička" author_email="martin.ruzicka@eman.cz" author_location="Prague, Czech Republic">
<Require feature="dynamic-height"/>
<Require feature="google.contentmatch">
<Param name="extractors">google.com:SenderEmailExtractor</Param>
</Require>
</ModulePrefs>
<Content type="html" view="card">
<![CDATA[
	<STYLE TYPE="text/css">
	TD{
		font-family: Arial; 
		font-size: 0.8em;
		vertical-align: top;
		margin-left: 2em;
	}
    	H3{
    		margin-top:	0.8em;
    		margin-left:	0.8em;
    	}
    	
    	.left{ 
    		float: left; 
    		width: 33%;
    		padding-right: 1em;
    		padding-left: 1em;
    	}
	.right{ 
		float: right; 
		width: 33%;
		padding-right: 1em;
    		padding-left: 1em;
	}
	.center{ 
		display: inline-block; 
		width: 33%;
		padding-right: 1em;
    		padding-left: 1em;
	}
    	
	</STYLE>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
<script type="text/javascript">
	
	var REDMINE_API_KEY = "acfc408436a5d9a15a028b986e91a5cd8ed29963";
	var DOMAIN = "https://redmine2.dev.eman.cz";
	
   	var matches = google.contentmatch.getContentMatches();        
	var email = matches[0]["sender_email"];
	
	var xhttp = new XMLHttpRequest();
  	xhttp.onreadystatechange = function() {
    		if (xhttp.readyState == 4 && xhttp.status == 200) {
			var object = JSON.parse(xhttp.responseText);					
			
			if ( object.total_count == 0 ) {
				var h = document.createElement("H3");                // Create a <h1> element
				var t = document.createTextNode("Pro odesílatele se v Redmine nenachází žadný kontakt");     // Create a text node
				h.appendChild(t);
				document.body.appendChild(h);
			} else {
				var contact = object.contacts[0];
			
				var table_contact = document.createElement("TD");
				
				var contact_name  = document.createElement("H3");
				var text = document.createTextNode( getValue( contact.prefix ) + " " + getValue( contact.first_name ) + " " + getValue( contact.middle_name ) + " " + getValue( contact.family_name ) + " " +getValue( contact.suffix ) );
								contact_name.appendChild(text);
				table_contact.appendChild(contact_name);
				
				var c, r, t, left, middle, right;
					//t.style.fontSize = "x-small";
				    left = document.createElement('div');
				    middle = document.createElement('div');
				    right = document.createElement('div');
				
					left.className = "left";
					middle.className = "middle";
					right.className = "right";
					
					
					table_contact.appendChild(t);
					
					var leftTable = document.createElement('table');
					var middleTable = document.createElement('table');
					var rightTable = document.createElement('table');
					
					left.appendChild(leftTable);
					middle.appendChild(middleTable);
					right.appendChild(rightTable);
					
					fillLeftTable (leftTable, contact);
					fillMiddleTable (middleTable, contact);
					fillRightTable (rightTable, contact);
									
					//table_contact.innerText = table_contact.innerText.replace('undefined', '');
				
				document.body.appendChild(table_contact);
			}
		}
  	};
  	xhttp.open("GET", DOMAIN + '/projects/crm/representatives.json?contact_email=' + email, true);
  	xhttp.setRequestHeader("X-Redmine-API-Key", REDMINE_API_KEY);
  	xhttp.send();
	
	function getValue( object) {
		return (object == null ? "" : object )
	}
	
	function fillLeftTable (table, contact) {
		var i = 0;
		if ( contact.company != null ) {
		    var r = table.insertRow(i++); 
		    var left = r.insertCell(0);
		    var right = r.insertCell(1);
			
			left.innerHTML = "Company	".bold();
			right.innerHTML = contact.company;
		}
		if ( contact.job_title != null ) {
		    var r = table.insertRow(i++); 
		    var left = r.insertCell(0);
		    var right = r.insertCell(1);
			
			left.innerHTML = "Job title	".bold();
			right.innerHTML = contact.job_title;
		}
		if ( contact.birth_day != null ) {
		    var r = table.insertRow(i++); 
		    var left = r.insertCell(0);
		    var right = r.insertCell(1);
			
			left.innerHTML = "Birthday	".bold();
			right.innerHTML = contact.birth_day;
		}
		if ( contact.skype != null ) {
		    var r = table.insertRow(i++); 
		    var left = r.insertCell(0);
		    var right = r.insertCell(1);
			
			left.innerHTML = "Skype	".bold();
			right.innerHTML = contact.skype;
		}
		if ( contact.assignee != null ) {
		    var r = table.insertRow(i++); 
		    var left = r.insertCell(0);
		    var right = r.insertCell(1);
			
			left.innerHTML = "Assignee	".bold();
			right.innerHTML = contact.assignee;
		}
		if ( contact.tags != null && contact.tags.length > 0 ) {
		    var r = table.insertRow(i++); 
		    var left = r.insertCell(0);
		    var right = r.insertCell(1);
			left.innerHTML = "Tags	".bold();
			var text = "";
			for (var j = 0; j < contact.tags.length; j++ ) {
				if (j == 0) {
					text = contact.tags[j];
				} else {
			    	text = text + ", " + contact.tags[j];
				}
			}
			right.innerHTML = text;
		}
	};
	
	function fillRightTable (table, contact) {
		var i = 0;
		if ( contact.phones != null && contact.phones.length > 0 ) {
			for (var j = 0; j < contact.phones.length; j++ ) {
			    var r = table.insertRow(i++ ); 
			    var left = r.insertCell(0);
			    var right = r.insertCell(1);
				left.innerHTML = contact.phones[j].category.bold() + "	";
				right.innerHTML = contact.phones[j].phone;
			}
		}
	};
	
	function fillMiddleTable (table, contact) {
		var i = 0;
		if ( contact.emails != null && contact.emails.length > 0 ) {
			for (var j = 0; j < contact.emails.length; j++ ) {
			    var r = table.insertRow(i++ ); 
			    var left = r.insertCell(0);
			    var right = r.insertCell(1);
				left.innerHTML = contact.emails[j].category.bold() + "	";
				right.innerHTML = contact.emails[j].email;
			}
		}
	};
	
	
	function onPageLoaded() {
	               gadgets.window.adjustHeight();
	                }	
					
	
</script>
]]>
</Content>
</Module>
